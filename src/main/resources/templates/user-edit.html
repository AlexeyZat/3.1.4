<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit User (API)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-5">
    <h2>Edit User</h2>

    <div id="alertBox"></div>

    <form id="editUserForm" class="border p-4 bg-light rounded">

        <input type="hidden" id="userId">

        <div class="mb-3">
            <label for="username" class="form-label">Username:</label>
            <input type="text" id="username" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="name" class="form-label">First Name:</label>
            <input type="text" id="name" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="lastName" class="form-label">Last Name:</label>
            <input type="text" id="lastName" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="age" class="form-label">Age:</label>
            <input type="number" id="age" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="email" class="form-label">Email:</label>
            <input type="email" id="email" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="password" class="form-label">Password:</label>
            <input type="password" id="password" class="form-control" placeholder="Enter new password or leave empty">
        </div>

        <div class="mb-3">
            <label for="roles" class="form-label">Roles:</label>
            <select id="roles" class="form-select" multiple required></select>
        </div>

        <button type="submit" class="btn btn-primary">Save</button>
        <a href="/admin" class="btn btn-secondary ms-2">Cancel</a>
    </form>
</div>

<script>
    const userId = new URLSearchParams(window.location.search).get('id');

    async function loadUserAndRoles() {
        const [userRes, rolesRes] = await Promise.all([
            fetch(`/api/admin/users/${userId}`),
            fetch(`/api/admin/roles`)
        ]);
        const user = await userRes.json();
        const roles = await rolesRes.json();

        document.getElementById('userId').value = user.id;
        document.getElementById('username').value = user.username;
        document.getElementById('name').value = user.name;
        document.getElementById('lastName').value = user.lastName;
        document.getElementById('age').value = user.age;
        document.getElementById('email').value = user.email;

        const select = document.getElementById('roles');
        select.innerHTML = '';
        roles.forEach(role => {
            const opt = document.createElement('option');
            opt.value = role.id;
            opt.textContent = role.name.replace('ROLE_', '');
            if (user.roles.some(r => r.id === role.id)) opt.selected = true;
            select.appendChild(opt);
        });
    }

    document.getElementById('editUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const selectedRoles = Array.from(document.getElementById('roles').selectedOptions)
            .map(o => ({id: o.value}));

        const updatedUser = {
            id: document.getElementById('userId').value,
            username: document.getElementById('username').value,
            name: document.getElementById('name').value,
            lastName: document.getElementById('lastName').value,
            age: document.getElementById('age').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            roles: selectedRoles
        };

        const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(updatedUser)
        });

        const alertBox = document.getElementById('alertBox');
        if (response.ok) {
            alertBox.innerHTML = `<div class="alert alert-success">User successfully updated!</div>`;
        } else {
            alertBox.innerHTML = `<div class="alert alert-danger">Update failed!</div>`;
        }
    });

    loadUserAndRoles();
</script>

</body>
</html>


